<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
		<meta content="yes" name="apple-mobile-web-app-capable" />
		<meta content="telephone=no" name="format-detection" />
		<meta name="browsermode" content="application">
		<meta name="renderer" content="webkit">
		<title>调研详情</title>
		<link rel="stylesheet" type="text/css" href="css/global.css" />
		<link rel="stylesheet" href="css/swiper.css">
		<link rel="stylesheet" href="css/loading.css">
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<script src="js/config.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/global.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/comUtil.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/syp_v1.js" type="text/javascript" charset="utf-8"></script> 
       <script type="text/javascript" charset="utf-8">
       	app_isback=false;
        window.SYP.setBannerTitle("调研详情");		
        </script>
        <style>.g-importList-title{min-width:2.4rem;}</style>
	</head>
	<body>
	<!-- <div class="selectfix">调研详情<div class="icon_return" onclick="appback('surveyList.html');"></div><div class="icon_refresh" onclick="window.location.reload(); "></div></div> -->
		<!-- 顶部菜单  -->
		<div class="swiper-container swiper-container1">
			<div class="swiper-wrapper" id="menu">
				<div class="swiper-slide on">调研概述</div>
				<div class="swiper-slide">商铺信息</div>
				<div class="swiper-slide">收银机信息</div>
				<div class="swiper-slide">打印机信息</div>
				<div class="swiper-slide">其他信息</div>
				<div class="swiper-slide">附件</div>
			</div>
		</div>
		<!-- 内容区 -->
		<div class="wrapbox">
		<div class="swiper-container swiper-container2">
			<div class="swiper-wrapper">
				<div class="swiper-slide">
					<ul class="g-importList">
		
						<li>
							<div class="g-importList-title">调研编号</div>
							<div class="g-importList-content">
								<div class="i-import" style="border:none">
									<input  type="text" id="dyid"  readonly />
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">商铺编号</div>
							<div class="g-importList-content">
								<div class="i-text" id="shopID"></div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">收银机编号</div>
							<div class="g-importList-content">
								<div class="i-text" id="shouyinid"></div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">打印机编号</div>
							<div class="g-importList-content">
								<div class="i-text" id="dayingid"></div>
							</div>
						</li>
					</ul>
				</div>
				<div class="swiper-slide">
					<ul class="g-importList">
						<li>
							<div class="g-importList-title">项目名称</div>
							<div class="g-importList-content">
								<div class="i-text">
									<div id="itemName" alertTitle="项目名称" class="on"></div>
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">商铺名称<span class="redtip">*</span></div>
							<div class="g-importList-content">
								<div class="i-xiala-list">
									<div id="shopName" alertTitle="请输入商铺名称进行搜索" onclick="app.select(this,2,shop.selectShopName)" class="on">未选择</div>
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">商铺状态</div>
							<div class="g-importList-content">
								<div class="i-text" id="shopState" ></div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">商铺位置</div>
							<div class="g-importList-content">
								<div class="i-text" id="shopSite"></div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">经营分类</div>
							<div class="g-importList-content">
								<div class="i-text" id="shopFl1"></div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">经营次分类</div>
							<div class="g-importList-content">
								<div class="i-text" id="shopFl2"></div>
							</div>
						</li>
					</ul>
				</div>
				<div class="swiper-slide">
					<ul class="g-importList">
						<li style="display:none">
							<div class="g-importList-title">收银机编号</div>
							<div class="g-importList-content">
								<div class="i-import">
									<input onblur="checkCode(this,'收银机')"  id="syjId" type="text" placeholder="请输入" />
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">收银机操作系统</div>
							<div class="g-importList-content">
								<div class="i-xiala-list">
									<div class="on" id="syjSystem"  alertTitle="收银机操作系统" >未选择</div>									
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">商户收银系统品牌</div>
							<div class="g-importList-content">
								<div class="i-import">
								<input id="syjBrand" type="text" placeholder="请输入">
									<!-- <div class="on" id="syjBrand" alertTitle="商户收银系统品牌">未选择</div> -->
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">收银机端接口<span class="redtip">*</span></div>
							<div class="g-importList-content">
								<div class="i-xiala-list">
									<div class="on" id="syjPort" alertTitle="收银机端接口">未选择</div>
								</div>
							</div>
						</li>
						<li>
							<div class="g-importList-title">有无驱动</div>
							<div class="g-importList-content">
								<div class="i-choice">
									<div class="i-choice-row">
										<div id="drive1" class="on" onclick="syj.qudong('是')"></div>
										<p>是</p>
									</div>
									<div class="i-choice-row">
										<div  id="drive2" onclick="syj.qudong('否')"></div>
										<p>否</p>
									</div>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="swiper-slide">
					<ul class="g-importList">
				    	<li style="display:none">
				    		<div class="g-importList-title">打印机编号</div>
				    		<div class="g-importList-content">
				    			<div class="i-import">
									<input onblur="checkCode(this,'打印机')"  type="text" id="dyjId" placeholder="请输入" />
								</div>
				    		</div>
				    	</li>
				    	<!--打印机品牌型号分开 start  -->
				    	<li>
				    		<div class="g-importList-title">打印机品牌<span class="redtip">*</span></div>
				    		<div class="g-importList-content">
				    			<div class="i-import">
									<input type="text"  id="dyjbrand" placeholder="请输入" />
								</div>
				    		</div>
				    	</li>
				    	<li>
				    		<div class="g-importList-title">打印机型号<span class="redtip">*</span></div>
				    		<div class="g-importList-content">
				    			<div class="i-import">
									<input type="text"  id="dyjxh" placeholder="请输入" />
								</div>
				    		</div>
				    	</li>
				    	<!--打印机品牌型号分开 end  -->
				    	<li>
				    		<div class="g-importList-title">打印机端口</div>
				    		<div class="g-importList-content">
				    			<div class="i-xiala-list">
									<div class="on" id="dyjPort" alertTitle="打印机端口">未选择</div>
								</div>
				    		</div>
				    	</li>
				    </ul>
				</div>
				<div class="swiper-slide">
					<ul class="g-importList">
					<!-- 添加商场内网 start-->
				    	<li style="height:auto;margin-bottom:0em;">
				    		<div class="g-importList-title2" style="width: 3.1rem;">商户网络情况</div>
				    		<div id="install_getdata" style="display:none"></div>
				    		<div class="g-importList-content" id="getnetwork">
				    		</div>
				    	</li>
				    	<!-- 添加商场内网 end-->
				    	<li>
				    		<div class="g-importList-title" style="width: 3.1rem;">空余电源插口情况</div>
				    		<div class="g-importList-content">
				    			<div class="i-choice">
				    				<div class="i-choice-row">
				    					<div id="qt3" onclick="qt.selectPlug('有')" class="on"></div>
				    					<p>有</p>
				    				</div>
				    				<div class="i-choice-row">
				    					<div id="qt4" onclick="qt.selectPlug('无')"></div>
				    					<p>无</p>
				    				</div>
				    			</div>
				    		</div>
				    	</li>
				    	<li>
				    		<div class="g-importList-title" style="width: 3.1rem;">租户是否有会员系统</div>
				    		<div class="g-importList-content">
				    			<div class="i-choice">
				    				<div class="i-choice-row">
				    					<div id="qt5" onclick="qt.selectVip('是')" class="on"></div>
				    					<p>是</p>
				    				</div>
				    				<div class="i-choice-row">
				    					<div id="qt6" onclick="qt.selectVip('否')"></div>
				    					<p>否</p>
				    				</div>
				    			</div>
				    		</div>
				    	</li>
				    	<li id="vipshow">
				    		<div class="g-importList-title" style="width: 3.1rem;">会员信息是否小票上体现</div>
				    		<div class="g-importList-content">
				    			<div class="i-choice">
				    				<div class="i-choice-row">
				    					<div id="qt7" onclick="qt.selectNote('是')" class="on"></div>
				    					<p>是</p>
				    				</div>
				    				<div class="i-choice-row">
				    					<div id="qt8" onclick="qt.selectNote('否')"></div>
				    					<p>否</p>
				    				</div>
				    			</div>
				    		</div>

				    	</li>
				    	<div  id="subnote">
				    	<li style="height:auto">
				    		<div class="g-importList-title2" style="width: 3.1rem;">会员信息</div>
				    		<div class="g-importList-content">
				    			<div class="i-choicechk" id="vipchkbox">
				    				
				    			</div>
				    		</div>

				    		<input type="hidden" id="vipinfo" value="未选择">
				    	</li>
				    	</div>
				    </ul>
				</div>
				<div class="swiper-slide">
					<div class="i-addImg">
						<div class="img" id="imgShow">
						</div>
						<div class="add"><input type="file" id="fileImg" onchange="app.getImgUrl();" accept="image/*"/></div>
						<div style="clear:both"></div>
					</div>
				</div>
			</div>
		</div>
		</div>
		<!-- 保存按钮 -->
		<div class="g-ok">
			<div id="save">保存</div>
		</div>
		
		<script src="js/swiper.js"></script>
		<script>
		loadCombobox("install_getdata",'network_state'); 
		  /*====安装cynthia ，获得安装编号 start===*/ 
            function getproId()
            {  $.ajax({
                url:domainName+ "/hdk/project/getFormCode",
                dataType:"jsonp",
                jsonp:"callback",
                data:{
                    formType:"survey",
                    proId:proId_name
                },
               type:"get",
               success:function(res){
               	  m_loading.remove();
                  $("#dyid").val(res.code);
               },
               error:function(res){      
               m_loading.remove();
               app.alert("自动生成编号失败",1);             
               } 
              });}           
            /*====安装cynthia ，获得安装编号 end===*/
		      var params = function() {
            var query = {},
            search = window.location.search.substring(1),
            parts = search.split('&'),
            pairs = [];

            for (var i = 0, len = parts.length; i < len; i++) {
                pairs = parts[i].split('=');
                query[pairs[0]] = (pairs.length > 1 ? decodeURIComponent(pairs[1]) : null);
             }

            return query;
         }();
			var shop = {	//商铺
				itemName:null,	//项目名称
				shop:null,		//商店集合
				shopName:null,	//商店名称
				item:null,		//项目集合
				itemId:null,	//项目id
				files:null,
				init:function(){
					this.initPorName();
				},
				selectPorName:function(){//选择项目名称
					shop.itemName = $('#itemName').html();
					shop.initShopName();
					
                   $("#shopState").html('');
                    $("#shopSite").html('');
                    $("#shopFl1").html('');
                    $("#shopFl2").html('');
                    $("#shopID").html('');
			   if(shop.item)
				{	
					for(var i = 0 ; i<shop.item.length; i++){
						if(shop.itemName == shop.item[i].proName){
							shop.itemId =  shop.item[i].proId;
						}
					}
				}
				},
				initPorName:function(){	//初始化项目名称
					var time  =  new Date().getTime();
					$.ajax({	
					   url:domainName+ "/hdk/project/getSome",
					   type: "get",
					   data:{"time":time},
					   dataType:"jsonp",
					   jsonpCallback:"project_"+time+"_getSome",
					   success:function(data){	
					   		shop.item = data;
					   		var text = ''
					   		for(var i = 0 ; i<data.length; i++){
					   			if(i == data.length -1){
					   				text += data[i].proName
					   			}else{
					   				text += data[i].proName + ','
					   			}
					   		}
					   		$('#itemName')[0].dataset.select = text
					   }					   
					})
				},
				selectShopName:function(){
					shop.shopName = $('#shopName').html();
					for(var i = 0 ; i<shop.shop.length; i++){
						if(shop.shopName == shop.shop[i].shopName){
							$("#shopState").html(shop.shop[i].shopMerStation);
							$("#shopSite").html(shop.shop[i].shopFloor);
							$("#shopFl1").html(shop.shop[i].shopType);
							$("#shopFl2").html(shop.shop[i].shopSecType);
							$("#shopID").html(shop.shop[i].shopId);
						}
					}
				},
				initShopName:function(){ //初始化商店名称
					
					$.ajax({	
					   url: domainName+"/hdk/shops/selectForCombobox",
					   type: "get",
					   data:{"proId":shop.itemName},
					   dataType:"jsonp",
					   jsonpCallback:"shops_selectForCombobox",
					   success:function(data){					   
					   		$('#shopName').addClass('on').html('未选择');
					   		$("#shopState").html('');
							$("#shopSite").html('');
							$("#shopFl1").html('');
							$("#shopFl2").html('');
							$("#shopID").html('');
							/*====数组排序 start====*/
							var result = data.sort(function(a,b){  
					          return a.surveyExist-b.surveyExist;  
					        });   
					   		/*====数组排序 end====*/
					   		surveryexArr=result;
					   		shop.shop = result;
					   		var text = ''
					   		for(var i = 0 ; i<data.length; i++){
					   			if(i == data.length -1){
					   				text += data[i].shopName
					   			}else{
					   				text += data[i].shopName + ','
					   			}
					   		}
					   		
					   		$('#shopName')[0].dataset.select = text
					   }					   
					})
				}
			}
			
			var syj = {	//收银机
				system:null,   //收银机系统
				brand:null,  //收银机器品牌
				port:null,   //收银机端口
				id:null,	//收银机编号
				drive:'是',	//有无驱动
				init:function(){
					//syj.syjSystem();
					//syj.syjBrand();
					//syj.syjPort();
					loadCombobox("syjSystem","cash_system",1);	
					$('#syjSystem').click(function(){
					   			app.select(this,2,syj.selectSyjSystem)
					   		})	
					//loadCombobox("syjBrand","cash_brand",1);	
					// $('#syjBrand').click(function(){
					//    			app.select(this,2,syj.selectSyjBrand)
					//    		})	
					loadCombobox("syjPort","cash_port",1);	
			
					$('#syjId').on('input propertychange', function() { 
						syj.id = $(this).val();
						$("#shouyinid").html(syj.id);
					});
					$('#syjPort').click(function(){
					   			app.select(this,2,syj.selectSyjPort)
					   		})
				},
				qudong:function(data){
					syj.drive = data;
				},
				selectSyjSystem:function(){
					syj.system = $('#syjSystem').html();
				},
				syjSystem:function(){
					var time  =  new Date().getTime();
					$.ajax({	
					   url:domainName+ "/hdk/state/getSome",
					   type: "get",
					   data:{"ownerTable":"cash_system","time":time},
					   dataType:"jsonp",
					   jsonpCallback:"state_"+time+"_getSome",
					   success:function(data){
					   		var text = ''
					   		for(var i = 0 ; i<data.length; i++){
					   			if(i == data.length -1){
					   				text += data[i].staName
					   			}else{
					   				text += data[i].staName + ','
					   			}
					   		}
					   		$('#syjSystem')[0].dataset.select = text;
					   		$('#syjSystem').click(function(){
					   			app.select(this,2,syj.selectSyjSystem)
					   		})					   		
					   }					   
					})
				},
				selectSyjBrand:function(){
					syj.brand = $('#syjBrand').html();
				},
				syjBrand:function(){	
					var time  =  new Date().getTime();
					$.ajax({	
					   url: domainName+"/hdk/state/getSome",
					   type: "get",
					   data:{"ownerTable":"cash_brand","time":time},
					   dataType:"jsonp",
					   jsonpCallback:"state_"+time+"_getSome",
					   success:function(data){
					   		var text = ''
					   		for(var i = 0 ; i<data.length; i++){
					   			if(i == data.length -1){
					   				text += data[i].staName
					   			}else{
					   				text += data[i].staName + ','
					   			}
					   		}
					   		$('#syjBrand')[0].dataset.select = text;
					   		$('#syjBrand').click(function(){
					   			app.select(this,2,syj.selectSyjBrand)
					   		})
					   }					   
					})
				},
				selectSyjPort:function(){
					syj.port = $('#syjPort').html();
				},
				syjPort:function(){
					var time  =  new Date().getTime();
					$.ajax({	
					   url: domainName+"/hdk/state/getSome",
					   type: "get",
					   data:{"ownerTable":"cash_port","time":time},
					   dataType:"jsonp",
					   jsonpCallback:"state_"+time+"_getSome",
					   success:function(data){
					   		var text = ''
					   		for(var i = 0 ; i<data.length; i++){
					   			if(i == data.length -1){
					   				text += data[i].staName
					   			}else{
					   				text += data[i].staName + ','
					   			}
					   		}
					   		$('#syjPort')[0].dataset.select = text;
					   		$('#syjPort').click(function(){
					   			app.select(this,2,syj.selectSyjPort)
					   		})
					   }					   
					})
				}
			}
			
			var dyj = {	//打印机
				port:null,	//打印机端口
				id:null,	//打印机ID
				init:function(){
					//dyj.dyjPort();
					loadCombobox("dyjPort","printer_port",1);	
					$('#dyjPort').click(function(){
					   			app.select(this,2,syj.selectDyjPort)
					   		})
					$('#dyjId').on('input propertychange', function() { 
						dyj.id = $(this).val();
						$("#dayingid").html(dyj.id);
					});
				},
				selectDyjPort:function(){
					dyj.port = $('#dyjPort').html();
				},
				dyjPort:function(){
					var time  =  new Date().getTime();
					$.ajax({	
					   url: domainName+"/hdk/state/getSome",
					   type: "get",
					   data:{"ownerTable":"printer_port","time":time},
					   dataType:"jsonp",
					   jsonpCallback:"state_"+time+"_getSome",
					   success:function(data){
					   		var text = ''
					   		for(var i = 0 ; i<data.length; i++){
					   			if(i == data.length -1){
					   				text += data[i].staName
					   			}else{
					   				text += data[i].staName + ','
					   			}
					   		}
					   		$('#dyjPort')[0].dataset.select = text;
					   		$('#dyjPort').click(function(){
					   			app.select(this,2,syj.selectDyjPort)
					   		})
					   		
					   }					   
					})
				}
			}
			
			var qt = {//其他
				network:"",	//网络情况
				plug:"有",		//电源插口情况 
				vip:"是",       //租户是否有会员系统
				note:"是",		//是否小票
				selectNetwork:function(obj){
					var data=$(obj).next("p").html();
					if($(obj).hasClass("on"))
					{
						$(obj).removeClass("on");
						var ss=qt.network.split(",")
						removeByValue(ss, data);						
						qt.network=ss.join(",");
						
			        }
				else
					{$(obj).addClass('on');
						if(qt.network.length==0)
						{qt.network+=data;}
						else
						{
							if(qt.network.indexOf(data)==-1)
							qt.network+=","+data;
						}

			      }
				},		
				selectPlug:function(data){
					qt.plug = data;
				},		
				selectVip:function(data){
					qt.vip = data;
					if(data == "是"){
						$("#vipshow").css("visibility","inherit");
						if(qt.note== "是")
						{$("#subnote").css("visibility","inherit");}
					}else{
						$("#vipshow").css("visibility","hidden");
						$("#subnote").css("visibility","hidden");
					}
				},		
				selectNote:function(data){
					qt.note = data;
					if(data == "是"){
						$("#subnote").css("visibility","inherit");
					}else{
						$("#subnote").css("visibility","hidden");
					}
				}
			};
			function valiate_submit()
			{if(form_empty({code:$('#dyid').val(), which:"调研编号"}))
			     	{return;}
				 if(form_empty({code:$('#itemName').html(), which:"项目名称"}))
				 	{return;}
				 if(form_empty({code:$('#shopName').html(), which:"商铺名称"}))
				 {
				 	swiper2.slideTo(1, 0, true);
        			return;
        		}
        		if(form_empty({code:$('#syjPort').html(), which:"收银机端接口"}))
				 {
				 	swiper2.slideTo(2, 0, true); 
        			return;
        		}
        		if(form_empty({code:$('#dyjbrand').val(), which:"打印机品牌"}))
				 {
				 	swiper2.slideTo(3, 0, true);
				 	$("#g-popupOk").bind("click",function(){ $('#dyjbrand').focus();})  
        			return;
        		}
        		if(form_empty({code:$('#dyjxh').val(), which:"打印机型号"}))
				 {
				 	swiper2.slideTo(3, 0, true);
				 	$("#g-popupOk").bind("click",function(){ $('#dyjxh').focus();})  
        			return;
        		}
        	}
			function submit(){//提交				
			     valiate_submit();
				 //验证收银机编号和打印机编号 start
				//  var syjSystem_txt=$("#syjSystem").html();
				//  var syjBrand_txt=$("#syjBrand").html();
				//  var syjPort_txt=$("#syjPort").html();
				// if(chk_brand(syjSystem_txt,syjBrand_txt,syjPort_txt,"#syjId"))
				// 	{return;}
				// var dyjbrand_txt=$("#dyjbrand").val();
				//  var dyjxh_txt=$("#dyjxh").html();
				//  var dyjPort_txt=$("#dyjPort").html();
				// if(chk_print(dyjbrand_txt,dyjxh_txt,dyjPort_txt,"#dyjId"))
				// 	{return;}
                 //验证收银机编号和打印机编号 end  
                 if(shop.item)
                 {
			       for(var i = 0 ; i<shop.item.length; i++){
                        if(shop.itemName == shop.item[i].proName){
                            shop.itemId =  shop.item[i].proId;
                            break;
                        }
                    }
                   }
				var obj = {
					//调研
					'survey.proId':shop.itemId,		//项目编号
					'files':JSON.stringify(imgs),
					'survey.shopId':$("#shopID").html(),	//商铺编号
					'survey.surNetwork':qt.network,			//网络环境
					'survey.surPower':qt.plug,				//电源插口
					'survey.surVip':qt.vip,					//会员系统
					'survey.vipInfo':$("#vipinfo").val(),	//会员信息
					'survey.surId':$("#dyid").val(),		  //调研编号
					'survey.surVipInfoTicket':qt.note,//会员信息是否小票上体现
//					'survey.attachmentUrl':JSON.stringify(imgs),
//					'survey.surRemarks':'',				 //备注？
					//收银机
					'cash.cashId':syj.id,				//收银机编号
					'cash.cashBrand':$("#syjBrand").val(),			//收银机品牌
					'cash.cashRegister':syj.system,		//收银系统
					'cash.cashSystem':syj.system,		//收银操作系统
					'cash.cashPort':syj.port,			//收银机端口
					'cash.printerDriver':syj.drive,		//是否有驱动
					'cash.surId'

					:$("#dyid").val(),		//调研编号
//					'cash.installId':'',				//安装编号？
					//打印机
					'printer.printerId':dyj.id,			//打印机编号
					/*====打印机品牌型号cynthia start===*/
					'printer.printerBrand':$("#dyjbrand").val(),			//打印机品牌
					'printer.printerModel':$("#dyjxh").val(),		//打印机型号
					/*====打印机品牌型号cynthia end===*/
					'printer.printerPort':$("#dyjPort").html(),		//打印机端口
					'printer.surId':$("#dyid").val(),	//调研编号
//					'installId':'',						//安装编号？			
					//门店信息
					'shops.shopId':$("#shopID").html(),	//门店编号
					'shops.shopPosition':$("#shopSite").html(),	//门店位置
					'shops.shopFloor':$("#shopSite").html(),	//门店楼层
					'shops.shopMerName':shop.itemName,	//商铺名称
					'shops.shopMerStation':$("#shopState").html(),	//商铺状态
					'shops.shopType':$("#shopFl1").html(),				//商铺分类
					'shops.shopSecType':$("#shopFl2").html(),			//商铺次分类
					'shops.shopName':$("#shopName").html(),	//商铺简称
					'shops.proId':shop.itemId,			//项目编号
//					'shops.eqType':'',					//采集点类型？
//					'shops.installId':'',				//安装编号？
//					'shops.installStation':'',		//安装状态？
//					'shops.eqId':''				//采集点编号？ 
				};
				try{
				$.when(codeUnique({
                                           tableName:"survey"
                                         ,codeField:"sur_id"
                                         ,code:$('#dyid').val()
                                         , which:"调研编码"
                                         ,extra:true
                    } )
                    ).done(function(){					   
               		  m_loading.html();
        				$.ajax({	
        					   url:domainName+ "/hdk/survey/submit",
        					   type: "post",
        					   data:obj,
                                beforeSend:ajaxLoading(),
                                complete:ajaxLoadEnd(),
        					   dataType:"json",			
        					  // jsonpCallback:"state_null_getSome",
        					   success:function(data){
                 					m_loading.remove();        					  
        					   		if(data.message == "success"){

        					   			               window.SYP.showAlertAndRedirectWithCleanStack("温馨提示", "保存成功",
                            					   			domainName + "/hdk/sjt/surveyList.html?syp_user_num="+params["userNum"]+"&syp_user_name="+params["userName"]);

        					   		}else if(data.message == "fail"){
        					   			app.alert('保存失败',1);
        					   		}
        					   },
        					   error:function(rs){
        					   	  m_loading.remove();  	
        					      app.alert(rs.status,1);
        					   }				   
        					});
					 }).fail(function(){
					m_loading.remove();  	
					 alert("网路问题，请重试");});//done end
					}catch(e){  
						m_loading.remove();  	
					    alert(e.name);
                    throw(e.name); //抛出异常 
            }
}
var vipinfovalue;
			function xgid()
			{var xgcashid=""

				if(typeof(xg.data.cash)!="undefined")
				{xgcashid=xg.data.cash.id; }
			 return xgcashid;
			}
			function printid()
			{
				var printerid="";
				if(xg.data.printer)
				{printerid=xg.data.printer.id;}
				return printerid;
			}
			function xgsubmit(){	//修改
				m_loading.html();
				valiate_submit();
				var obj={
                    'files':(JSON.stringify(imgs)),
					'survey.proId':xg.data.survey.proId,	//项目编号
					'survey.shopId':$('#shopID').html(),		//门店编号
					'survey.surNetwork':qt.network,	//商户网络环境
					'survey.surPower':qt.plug,		//电源插卡
					'survey.surVip':qt.vip,		//会员系统
					'survey.surVipInfoTicket':qt.note,//会员信息是否小票上体现
					'survey.vipInfo':$("#vipinfo").val(),	//会员信息
//					'survey.createdAt':'',	//创建时间？
					'survey.surId':$('#dyid').val(),		//调研编码
//					'survey.updatedAt':'',	//更新时间？
//					'survey.surRemarks':'',   //备注
					'survey.attachmentUrl':JSON.stringify(imgs),
					'survey.id':xg.data.survey.id,		//自增id
					'cash.cashId':$('#shouyinid').html(),	//收音机编号
					'cash.cashBrand':$('#syjBrand').val(),	//收银机品牌
					'cash.cashRegister':$('#syjSystem').html(),	//收银机系统
					'cash.cashSystem':$('#syjSystem').html(),		//收银机操作系统
					'cash.cashPort':$('#syjPort').html(),	//收银机端口
					'cash.printerDriver':syj.drive,	//是否有驱动
					'cash.surId':$('#dyid').val(),	//调研编号
					'cash.id':xgid(),	//自增id
					'printer.id':printid(),	//打印机自增id
					'printer.printerId':$('#dyjId').val(),	//打印机编号
					/*====打印机品牌型号cynthia start====*/	
					'printer.printerBrand':$("#dyjbrand").val(),	//打印机品牌
					'printer.printerModel':$("#dyjxh").val(),	//打印机型号
					/*====打印机品牌型号cynthia start====*/	
					'printer.printerPort':$('#dyjPort').html(),	//打印机端口
					'printer.surId':$('#dyid').val(),	//调研编号
					'shops.id':xg.data.shops.id,	//门店自增id
					'shops.shopId':$("#shopID").html(),	//门店编号
					'shops.shopPosition':$('#shopSite').html(), //门店位置
					'shops.shopFloor':$('#shopSite').html(),	//楼层
					'shops.shopMerName':$('#shopName').html(),	//商铺名称
					'shops.shopMerStation':$('#shopState').html(),	//商品状态
					'shops.shopType':$('#shopFl1').html(),	//商品分类
					'shops.shopSecType':$('#shopFl2').html(),	//商品次分类
					'shops.shopName':$("#shopName").html(),	//商品简称
					'shops.proId':xg.data.shops.proId	//项目编号
				};
				$.ajax({	
					   url: domainName+"/hdk/survey/modify",
					   //url: "http://localhost:8080/hdk/survey/modify",
					   type: "post",
					   data:obj,
					   beforeSend:ajaxLoading(),
                       complete:ajaxLoadEnd(),
					   dataType:"json",			
					  // jsonpCallback:"state_null_getSome",
					   success:function(data){
					   	m_loading.remove();
					   		if(data.message == "success"){	
                                 window.SYP.showAlertAndRedirectWithCleanStack("温馨提示", "保存成功",
                                                            domainName + "/hdk/sjt/surveyList.html?syp_user_num="+params["userNum"]+"&syp_user_name="+params["userName"]);


					   		}else if(data.message == "fail"){
					   			app.alert('修改失败',1);
					   		}
					   },
                       error:function(rs){
                       	m_loading.remove();
                           app.alert(rs.status,1);
                       }    					   
					});
			}
			var viparr=[];
			var xg = {
				surId:null,	
				data:null,
				init:function(id){
					xg.surId = id;
					xg.getData();
				},
				getData:function(){
					$.ajax({	
					   url: domainName+"/hdk/survey/gotoModify",
					   // url: "http://localhost:8080/hdk/survey/gotoModify",
					   type: "get",
					   data:{"surId":xg.surId},
					   dataType:"jsonp",			
					  // jsonpCallback:"forword:/surveyDetails.jsp",
					   success:function(data){
					   		m_loading.remove();	
					   		xg.upStyle(data);
					   		xg.data = data;					   		
					   }					   
					});
				},
				upStyle:function(data){	
					//调研概述
					$("#dyid").val(xg.surId);
					xg.zhidu("dyid");
					$("#shopID").html(data.shops.shopId);	
					if(undefined != data.cash){				
					   $("#shouyinid").html(data.cash.cashId);
					}
					if(undefined != data.printer){
					   $("#dayingid").html(data.printer.printerId);
					}
					//商铺信息
					$("#itemName").html(data.survey.proName);
					xg.zhidu("itemName");
					$("#shopName").html(data.shops.shopMerName);
					xg.zhidu("shopName");
					$("#shopState").html(data.shops.shopMerStation);
					$("#shopSite").html(data.shops.shopPosition);
					$("#shopFl1").html(data.shops.shopType);
					$("#shopFl2").html(data.shops.shopSecType);
					//收银机
					if(undefined != data.cash){
					$("#syjId").val(data.cash.cashId);
					$("#syjSystem").html(data.cash.cashSystem);
					xg.youzhi("syjSystem");
					$("#syjBrand").val(data.cash.cashBrand);
					xg.youzhi("syjBrand");
					$("#syjPort").html(data.cash.cashPort);
					xg.youzhi("syjPort");
					if(data.cash.printerDriver == "是"){
					}else{
						syj.drive = "否";
						$("#drive1").removeClass('on');
						$("#drive2").addClass('on');
					}
					}
					//打印机
					if(undefined != data.printer){
					$("#dyjId").val(data.printer.printerId);
					/*===打印机品牌型号cynthia start===*/
					$("#dyjbrand").val(data.printer.printerBrand);
					$("#dyjxh").val(data.printer.printerModel);
					/*===打印机品牌型号cynthia end===*/
					$("#dyjPort").html(data.printer.printerPort);
					xg.youzhi("dyjPort");
					}
					var datanetwork=data.survey.surNetwork;
					//window.setTimeout('loadnetwork(network)',500);
					qt.network = data.survey.surNetwork;

					$("#getnetwork .i-choice-rowchk").each(function(i){
			           var objp=$(this).find("p");
			           var objdiv=$(this).find("div");
			           console.log(datanetwork);
			           if(datanetwork.indexOf(objp.html())!=-1){
			            objdiv.addClass('on');
			           }

			        })
					//其他 
					// if(data.survey.surNetwork.indexOf("外网")!=-1){
					// 	$('#qt1').addClass('on');
					// 	qt.network = data.survey.surNetwork;
					// }
					// if(data.survey.surNetwork.indexOf("wifi")!=-1){
					// 	$('#qt2').addClass('on');
					// 	qt.network = data.survey.surNetwork;
					// }
					// if(data.survey.surNetwork.indexOf("商场内网")!=-1){
					// 	$('#qtnetwork').addClass('on');
					// 	qt.network = data.survey.surNetwork;
					// }				
					console.log("test"+data.survey.surVip );					
					if(data.survey.surVipInfoTicket=="是")
                    { $("#subnote").css("visibility","inherit");
                	  $('#qt7').addClass('on');
                	  $('#qt8').removeClass('on');
                    }
                    else
                    {
                      $("#subnote").css("visibility","hidden");
                	  $('#qt8').addClass('on');
                	  $('#qt7').removeClass('on');
                    }
                    console.log("survip "+data.survey.surVip);
                    if(data.survey.surVip == "是"){
						$('#qt5').addClass('on');
						$('#qt6').removeClass('on');
						$("#vipshow").css("visibility","inherit");
						qt.vip = "是";
					}else if(data.survey.surVip == "否"){
						$('#qt6').addClass('on');
						$('#qt5').removeClass('on');
						$("#vipshow").css("visibility","hidden");
						$("#subnote").css("visibility","hidden");
						qt.vip = "否";
					}
						if(data.survey.surPower == "有"){
						$('#qt3').addClass('on');
						$('#qt4').removeClass('on');
						qt.plug = "有";
					}else if(data.survey.surPower == "无"){
						$('#qt4').addClass('on');
						$('#qt3').removeClass('on');
						qt.plug = "无";
					}
					
					

                    /*===cynthia 会员信息 start===*/
                    vipinfovalue=data.survey.vipInfo;   
                    console.log(vipinfovalue);
                    
                    if(vipinfovalue != null && vipinfovalue !="未选择" ){
                        //$('#qt7').addClass('on');
                        qt.note = "是";
                        // $("#vipshow").css("visibility","inherit");
                        // $("#subnote").css("visibility","inherit");
                        viparr=vipinfovalue.split(",");
                        $('#vipinfo').val(vipinfovalue);
                        setTimeout('func_chkvip()',400);
                    }
                    /*===cynthia 会员信息 end===*/
					if( data.survey.attachmentUrl != '' &&  data.survey.attachmentUrl != null &&  data.survey.attachmentUrl != undefined){
						imgs = shop.files = data.survey.attachmentUrl.split(",");

						for(var i = 0; i<shop.files.length; i++){
							$("#imgShow").append('<div ></div>');
							app.addImg(shop.files[i]);
						}
					}
				},
				zhidu:function(id){
					$("#" + id).removeClass('on');
					$("#" + id).parent('div').css('border','none');
					$("#" + id).css('background','none');
					$("#" + id).attr('readonly','readonly');
				},
				youzhi:function(id){
					$("#" + id).removeClass('on');
				}
			}

			/*===cynthia 会员信息 start===*/
            function func_chkvip()
            {   $("#vipchkbox .i-choice-rowchk").each(function(i){
                            var viptxt=$(this).find("p").html();
                            var vipchktxt=$('#vipinfo').val();
                             console.log(vipinfovalue);
                            if (vipinfovalue.indexOf(viptxt)!=-1)
                                {$(this).find("div").addClass("on");}
                          });
         }
         /*===cynthia 会员信息 end===*/

			var proId_name="";
			 function loadsurvey(id , table,isAll){
				 var time = (new Date().getTime());
				 var qtidx,vipid;
				 $.ajax({ 
					 url: domainName+'/hdk/state/getSome',
					 type:'get',
					 data:{
							'ownerTable':"vip_info"
					 },
				 		//jsonpCallback:"state_"+time+"_getSome",
				 		jsonp: "callback",
					 dataType:'jsonp',
					 success:function(rs){
						 var str = '';
						 var i = 0 ;
						 if(rs.length==0)
						 {$("#vipchkbox").html("<div style='padding-top:10px'>未配置会员信息</div>");}
						 else
						 {	
						 $.each(rs,function(index,item){
						var vipinfotxt='<div class="i-choice-rowchk"><div></div><p>'+item.staName+'</p></div>';
							 $("#vipchkbox").append(vipinfotxt);
							 qtidx=index+9;
							 vipid="qt"+qtidx;
							 //"#vipchkbox").find(".i-choice-rowchk").eq(index).find("div").attr("id",vipid);								 				 
						 });
						}
					 },
					 error:function(rs){
					 }
				 });
				
			 }
			 /*===返回2 start===*/
			 var surtestId;
			 /*===返回2 end===*/
			$(function(){	
			m_loading.html();	
			/*===保存返回 start===*/
	        window.SYP.saveParam (false,1);
	        $("input,textarea").bind("focus",function(){
	             window.SYP.saveParam (true,1);
	         })  
	        $(".i-text,.i-choice-row,.i-choice-rowchk").bind("click",function(){
	             window.SYP.saveParam (true,1);
	         })   
	         $("#getnetwork,#vipchkbox").on("click",".i-choice-rowchk",function(){
             window.SYP.saveParam (true,1);
         })      
	        /*===保存返回 end===*/		
				var surId = app.getUrlSearch("surId");	
				/*===返回2 start===*/
				surtestId=surId;		
				/*===返回2 end===*/			
				if(surId == null){	// 新建
					shop.init();
					syj.init();
					dyj.init();
					var time = new Date().getTime();
		            
		            $.ajax({
		              url: domainName +  '/hdk/project/getSome',
		              type: 'get',
		              data: {
		                time: time
		              },
		              jsonpCallback: "project_" + time + "_getSome",
		              jsonp: "callback",
		              dataType: 'jsonp',
		              success: function(rs) {
		                var str = '';
		                var i = 0;
		                $.each(rs, function(index, item) {
		                  if(item.proName==params["pproName"])
		                   {proId_name=item.proId;}

		                });
		               /*====获得编号 start=====*/
		               getproId()
		               /*====获得编号 end=====*/
		              },
		              error: function(rs) {
		                console.log(rs);
		              }
		            });  
					$("#save").click(function(){ //保存按钮
						app.alert("确定要保存吗？",2,submit)
					});
				}else{	//修改
					xg.init(surId);
					syj.init();
					dyj.init();
					$("#save").click(function(){ //保存按钮
						app.alert("确定要保存吗？",2,xgsubmit);
					});
				}
				loadsurvey();
				 //img start
                $("#imgShow").on("click","div",function(){
                    var i=$(this).index();
                    app.fullImg(i);
                })
                //img end
			});
			swiper1 = new Swiper('.swiper-container1', {	//菜单区滑块
				paginationClickable: true,
				slidesPerView: 'auto',
				freeMode: true
			});
			
			swiper2 = new Swiper('.swiper-container2', {	//内容区滑块
				autoHeight: true,
				onSlidePrevStart: function(swiper) {
					app.upStyle(swiper.activeIndex);
				},
				onSlideNextStart: function(swiper) {
					app.upStyle(swiper.activeIndex);
				}
			});
			

            if(undefined != params["pproName"] && "" !=params["pproName"] ){
                $('#itemName').html(params["pproName"]);
                $('#itemName').attr("class","");
                shop.itemName = params["pproName"];
                shop.selectPorName();
            }

				 $("#vipchkbox").on("click",".i-choice-rowchk",function()
				 		{

				 	var data=$(this).find("p").html();
				 	//会员信息 start	
				 	var objthis=$(this).find("div");
				 			 	
				 	if(objthis.hasClass("on"))
					{
						
						removeByValue(viparr, data);
						objthis.removeClass("on");
			        }
				else
					{
						viparr.push(data);
						objthis.addClass('on');
			     	}
			     	
			     	$("#vipinfo").val(viparr.join(","));
			     	//会员信息 end
				 })
				 /*===cynthia返回 start2===*/
			function submitback()
			{
				if(surtestId == null){
					submit();
				}
				else
				{
					xgsubmit();
				}

			}
			$(".g-importList-title").bind("click",function(){


			})
/*===cynthia返回 end2===*/
		</script>
	</body>
</html>